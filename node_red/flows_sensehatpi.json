[{"id":"9040230c.6fbfe","type":"tab","label":"SenseHAT pos & move skull"},{"id":"879a5ec1.337f9","type":"tab","label":"IP address"},{"id":"af380220.50c8","type":"mqtt-broker","z":"9040230c.6fbfe","broker":"192.168.1.30","port":"1883","clientid":"","usetls":false,"verifyservercert":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":null,"birthPayload":"","willTopic":"","willQos":"0","willRetain":null,"willPayload":""},{"id":"3a4d13cf.e1e27c","type":"mqtt-broker","z":"9040230c.6fbfe","broker":"localhost","port":"1883","clientid":"","usetls":false,"verifyservercert":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":null,"birthPayload":"","willTopic":"","willQos":"0","willRetain":null,"willPayload":""},{"id":"265a5782.1bf7a8","type":"mqtt-broker","z":"9040230c.6fbfe","broker":"192.168.1.51","port":"1883","clientid":"","usetls":false,"verifyservercert":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":null,"birthPayload":"","willTopic":"","willQos":"0","willRetain":null,"willPayload":""},{"id":"d9349b73.7bd508","type":"MySQLdatabase","z":"9040230c.6fbfe","host":"127.0.0.1","port":"3306","db":"sense_pi","tz":""},{"id":"a4fe522b.5b01b","type":"mqtt out","z":"9040230c.6fbfe","name":"","topic":"/servoshield/1/incoming","qos":"","retain":"","broker":"3a4d13cf.e1e27c","x":776.5,"y":366,"wires":[]},{"id":"db6fa0b4.24906","type":"rpi-sensehat in","z":"9040230c.6fbfe","name":"","motion":true,"env":true,"stick":true,"x":90,"y":40,"wires":[["bb975142.4468b","2d6b3306.e3b86c","29cfddf7.2cedb2","73381868.8cc7e8"]]},{"id":"bb975142.4468b","type":"switch","z":"9040230c.6fbfe","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"joystick","vt":"str"}],"checkall":"true","outputs":1,"x":156.5,"y":275,"wires":[["f78ce58b.087318"]]},{"id":"1bfd51b8.e402ae","type":"rpi-sensehat out","z":"9040230c.6fbfe","name":"","x":850,"y":500,"wires":[]},{"id":"ec568108.13a98","type":"function","z":"9040230c.6fbfe","name":"control LED","func":"var X=(flow.get(\"X\")||4)-1;\nvar Y=(flow.get(\"Y\")||3)-1;\n\n\nif(msg.payload.key==\"LEFT\" && (X>0)){\n    X=X-1;\n}\n\nif(msg.payload.key==\"RIGHT\" && (X<7)){\n    X=X+1;\n}\nif(msg.payload.key==\"UP\" && (Y>0)){\n    Y=Y-1;\n}\nif(msg.payload.key==\"DOWN\" && (Y<7)){\n    Y=Y+1;\n}\n\nflow.set(\"X\",X+1);\nflow.set(\"Y\",Y+1);\n\nvar msg1 = { payload:\"*,*,black\" };\nvar msg2 = { payload:util.format(\"%d,%d,red\",X,Y) };\n\nreturn [msg1,msg2];","outputs":"2","noerr":0,"x":375.5,"y":376,"wires":[["1bfd51b8.e402ae"],["1bfd51b8.e402ae"]]},{"id":"f78ce58b.087318","type":"switch","z":"9040230c.6fbfe","name":"","property":"payload.state","propertyType":"msg","rules":[{"t":"neq","v":"0","vt":"num"}],"checkall":"true","outputs":1,"x":152.5,"y":335,"wires":[["d8fc1b89.c99098","7046b819.8fb948","ec568108.13a98"]]},{"id":"7046b819.8fb948","type":"function","z":"9040230c.6fbfe","name":"control skull","func":"var    servoXMin=200; //  The commented numbers are for the old pan/tilt set\nvar    servoXMax=520; // \nvar    servoXMid=330; // 360\nvar    servoYMin=235; //\nvar     servoYMax=520; //\nvar    servoYMid=300; // 320\n\nvar increment=2;\n\nif(msg.payload.key==\"ENTER\"){\n    msg.payload=\"JAW_MOTION, 1, 1\"; \n    return msg;\n}\n\nvar SX=(flow.get(\"SX\"))||servoXMid;\nvar SY=(flow.get(\"SY\"))||servoYMid;\n\nif(msg.payload.key==\"LEFT\" && (SX>servoXMin)){\n    SX=SX-increment;\n}\n\nif(msg.payload.key==\"RIGHT\" && (SX<servoXMax)){\n    SX=SX+increment;\n}\nif(msg.payload.key==\"UP\" && (SY>servoYMin)){\n    SY=SY-increment;\n}\nif(msg.payload.key==\"DOWN\" && (SY<servoYMax)){\n    SY=SY+increment;\n}\n\nflow.set(\"SX\",SX);\nflow.set(\"SY\",SY);\n\nvar msg1 = { payload:util.format(\"SERVOS_MOVE,%d,%d,7\",SX,SY) };\n\nreturn msg1;\n","outputs":1,"noerr":0,"x":498.5,"y":313,"wires":[["a4fe522b.5b01b"]]},{"id":"73381868.8cc7e8","type":"mqtt out","z":"9040230c.6fbfe","name":"","topic":"/sensehat/1/status","qos":"","retain":"","broker":"3a4d13cf.e1e27c","x":250,"y":220,"wires":[]},{"id":"312177c7.075608","type":"mqtt in","z":"9040230c.6fbfe","name":"","topic":"/sensepi","broker":"3a4d13cf.e1e27c","x":400,"y":480,"wires":[["1bfd51b8.e402ae"]]},{"id":"d8fc1b89.c99098","type":"switch","z":"9040230c.6fbfe","name":"","property":"payload.key","propertyType":"msg","rules":[{"t":"eq","v":"ENTER","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":157.5,"y":386,"wires":[["58c50dbe.1d7404"]]},{"id":"58c50dbe.1d7404","type":"exec","z":"9040230c.6fbfe","command":"ifconfig | sed -En 's/127.0.0.1//;s/.*inet (addr:)?(([0-9]*\\.){3}[0-9]*).*/\\2/p'","addpay":false,"append":"","useSpawn":"false","timer":"0.5","oldrc":false,"name":"getIP","x":143.5,"y":492.5,"wires":[["8c7c3b17.e99658"],[],[]],"icon":"node-red-node-rbe/rbe.png"},{"id":"c835c4ab.229308","type":"debug","z":"9040230c.6fbfe","name":"","active":true,"console":"false","complete":"payload_text","x":809.5,"y":63,"wires":[]},{"id":"1fa52201.814e4e","type":"http request","z":"9040230c.6fbfe","name":"","method":"POST","ret":"obj","url":"http://10.0.0.107:9042/api/receivers/sense_hat_readings/entities","x":730,"y":140,"wires":[["c835c4ab.229308"]]},{"id":"f607ea4f.117218","type":"function","z":"9040230c.6fbfe","name":"add_properties","func":"var d = new Date();\n\nvar headers={\n    \"Content-Type\":\"application/json\"\n}\n\nmsg.payload._id=d.toString();\nmsg.payload.topic=msg.topic;\nmsg.headers=headers;\nreturn msg;","outputs":1,"noerr":0,"x":580.5,"y":25,"wires":[[]]},{"id":"2d6b3306.e3b86c","type":"delay","z":"9040230c.6fbfe","name":"throttle","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"6","nbRateUnits":"","rateUnits":"minute","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":310,"y":40,"wires":[["f607ea4f.117218","4ddc08fa.e52af8"]]},{"id":"29cfddf7.2cedb2","type":"switch","z":"9040230c.6fbfe","name":"topic filter","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"environment","vt":"str"},{"t":"eq","v":"joystick","vt":"str"}],"checkall":"true","outputs":2,"x":320,"y":100,"wires":[["c026077a.ad80d8"],["f607ea4f.117218"]]},{"id":"c026077a.ad80d8","type":"delay","z":"9040230c.6fbfe","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"6","rateUnits":"minute","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":510,"y":100,"wires":[["f607ea4f.117218","4ddc08fa.e52af8"]]},{"id":"a1d704a7.21b488","type":"template","z":"9040230c.6fbfe","name":"Format SQL","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"insert into raw_measurements(meastime,measurement_type,measurement) values (now(),'{{topic}}','{{sql}}') ","x":510,"y":240,"wires":[[]]},{"id":"4ddc08fa.e52af8","type":"function","z":"9040230c.6fbfe","name":"tostring","func":"var tmp=JSON.stringify(msg.payload,null,3);\ntmp.replace(/&quot;/g, '\\\\\"');\nmsg.topic=\"insert into raw_measurements(meastime,measurement_type,measurement) values (now(),'\"+msg.topic+\"','\"+tmp+\"') \"\nreturn msg;","outputs":1,"noerr":0,"x":341.5,"y":172,"wires":[[]]},{"id":"571921b6.9107c","type":"debug","z":"9040230c.6fbfe","name":"","active":true,"console":"false","complete":"topic","x":777.5,"y":259,"wires":[]},{"id":"efcaa2f2.dce43","type":"debug","z":"9040230c.6fbfe","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":830,"y":600,"wires":[]},{"id":"8c7c3b17.e99658","type":"function","z":"9040230c.6fbfe","name":"","func":"msg.payload= msg.payload.replace(/\\r?\\n|\\r/g, \"\");\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":620,"wires":[["efcaa2f2.dce43","1bfd51b8.e402ae"]]},{"id":"d4023d25.a80f","type":"delay","z":"9040230c.6fbfe","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":380,"y":700,"wires":[[]]},{"id":"abcaea93.5a3f98","type":"bitio-input","z":"9040230c.6fbfe","name":"","serialport":"","enablebuffer":true,"x":860,"y":760,"wires":[]},{"id":"64604ed6.79d01","type":"inject","z":"9040230c.6fbfe","name":"","topic":"","payload":"hei","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":740,"wires":[["abcaea93.5a3f98"]]}]